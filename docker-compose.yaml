services:
  textbee-db:
    container_name: textbee-db
    image: 'mongo:latest'
    restart: always
    environment:
      - 'MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-adminUser}'
      - 'MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASS:-adminPassword}'
      - MONGO_INITDB_DATABASE=textbee
    volumes:
      - 'mongodb_data:/data/db'
    networks:
      - coolify
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3

  textbee-api:
    container_name: textbee-api
    build:
      context: ./api
      dockerfile: Dockerfile
    restart: always
    environment:
      - PORT=3001
      - 'MONGODB_URI=mongodb://${MONGO_ROOT_USER:-adminUser}:${MONGO_ROOT_PASS:-adminPassword}@textbee-db:27017/textbee?authSource=admin'
      - 'REDIS_URL=redis://textbee-redis:6379'
    depends_on:
      textbee-db:
        condition: service_healthy
    networks:
      - coolify

  textbee-web:
    container_name: textbee-web
    build:
      context: ./web
      dockerfile: Dockerfile
    restart: always
    environment:
      - PORT=3000
      - 'NEXT_PUBLIC_API_BASE_URL=${SERVICE_FQDN_TEXTBEE_API}/api/v1'
      - 'NEXT_PUBLIC_SITE_URL=${SERVICE_FQDN_TEXTBEE_DASHBOARD}'
    depends_on:
      - textbee-api
    networks:
      - coolify

  textbee-redis:
    container_name: textbee-redis
    image: 'redis:alpine'
    restart: always
    volumes:
      - 'redis_data:/data'
    networks:
      - coolify

# --- THIS PART WAS MISSING OR INCORRECT ---
networks:
  coolify:
    external: true

volumes:
  mongodb_data:
  redis_data:
